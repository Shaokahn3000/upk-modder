Reworking defections ...

Taking back countries that have been taken over by the aliens

In XGWorld, the defected countries are stored in the array TCouncilMeeting.arrLeavingCountries

This is invoked from XGContinent.WhoIsLeaving

The actual leaving process is handled via the call : XGCountry.LeaveXComProject


Leaving the XCOM Project has the following effects:

function LeaveXComProject()
{
    if(LeftXCom()) // can't leave twice
    {
        return;
    }
    AI().ClearFromAbductionList(byte(GetID())); // clears any outstanding abductions pending (ones planned at the start of the month
    m_iFunding = 0; // funding goes to zero
    m_iPanic = -1;  // panic is reset to -1
    m_bSecretPact = true;  // save that the country has left
    GEOSCAPE().ColorCountry(byte(GetID()), GetPanicColor());  // color the country
    Game().CheckForLoseGame();  // check for losing
    if(HasSatelliteCoverage())
    {
        HQ().RemoveSatellite(m_kTCountry.iEnum);  // remove satellite coverage
    }
    World().m_kFundingCouncil.OnCountryLeft(byte(GetID()));  // remove any pending FC Requests
    World().m_iNumCountriesLost += 1;  // increment number of lost countries
    STAT_AddStat(20, 1);  // update game stats
    SetEntity(Spawn(class'XGEntity'), GetStormEntity());   // set storm over country
    //return;    
}

Potential changes to a country being conquered
1) Leave satellite in orbit -- possible condition to attacking the country
2) Spawn a new alien base if first base has been destroyed and if there is satellite coverage over the country




Re-instating a country would require the following :
1) Nothing for abductions -- Terror targets are also cleared from abduction lists -- it has no effect in subsequent months
2) Restore funding
3) Set m_bSecretPact = false;
4) Set panic to 4
5) Recolor the country based on new panic
6) Decrement World().m_iNumCountryiesLost
7) Remove storm over country 
    if(m_kEntity.GetEntity() != none)
    {
        m_kEntity.HideEntity(true);
        m_kEntity.GetEntity().Destroy();
    }


Thoughts on conditions for re-adding a country :
1) Country must have satellite in orbit (UFOs have greater chance to shoot down sats over conquered countries?)
2) Satellite allows detection of alien base -- creates base mission within the country
3) Base mission success results in re-instatement of country into Funding Council at panic level 4

eMission_AlienBase = 6

In XGGeoscape.AddMission the following code handles adding a new base mission:
	if(kMission.m_iMissionType == 6)
	{
		kMission.SetEntity(Spawn(class'XGMissionEntity'), 19);
		Alert(MakeAlert(8, kMission.m_iID));
	}
Excepting FC Missions and the first mission, AddMission is called from XGStrategyAI

Currently the sole alien base is created with XGStrategyAI.CreateBaseMission :

function CreateAlienBase()
{
    local XGMission_AlienBase kMission;

    kMission = Spawn(class'XGMission_AlienBase');
    kMission.m_kDesc = Spawn(class'XGBattleDesc');
    switch(Rand(5))
    {
        // End:0xC5
        case 0:
            kMission.m_iContinent = 0;
            kMission.m_v2Coords = vect2d(0.3020, 0.3940);
            // End:0x236
            break;
        // End:0x120
        case 1:
            kMission.m_iContinent = 4;
            kMission.m_v2Coords = vect2d(0.6040, 0.4870);
            // End:0x236
            break;
        // End:0x17C
        case 2:
            kMission.m_iContinent = 2;
            kMission.m_v2Coords = vect2d(0.4470, 0.140);
            // End:0x236
            break;
        // End:0x1D8
        case 3:
            kMission.m_iContinent = 3;
            kMission.m_v2Coords = vect2d(0.8290, 0.1360);
            // End:0x236
            break;
        // End:0x233
        case 4:
            kMission.m_iContinent = 1;
            kMission.m_v2Coords = vect2d(0.2940, 0.4690);
            // End:0x236
            break;
        // End:0xFFFF
        default:
            kMission.m_kDesc.m_kAlienSquad = DetermineAlienBaseSquad();
            kMission.m_arrArtifacts[172] = 50;
            kMission.m_arrArtifacts[179] = 3;
            kMission.m_arrArtifacts[171] = int(class'XGTacticalGameCore'.default.UFO_ELERIUM_PER_POWER_SOURCE[Game().GetDifficulty()] * float(kMission.m_arrArtifacts[179]));
            kMission.m_arrArtifacts[178] = 4;
            kMission.m_arrArtifacts[176] = 15;
            kMission.m_arrArtifacts[175] = 10;
            kMission.m_arrArtifacts[174] = 1;
            kMission.m_arrArtifacts[180] = 1;
            GEOSCAPE().AddMission(kMission);
            //return;
    }    
}

There is a specific location on each continent, but the continent is randomly selected.

Changes required :
1) Need to be able to create a base mission within a particular specified country.
2) Possible modifications to DetermineAlienBaseSquad()
3) Alteration of artifacts (reduction for regular Alien Base)
4) 


To trigger the country rejoining XCOM, use the function XGStrategyAI.ApplyMissionPanic



Plotline : Plot requires destruction of an alien base. First one grants item for research and creation of the Hyperwave Beacon. To ensure an alien base to attack, at least one country begins under alien control. (could be more on higher difficulties).

Add new subobjective under eObj_AssaultAlienBase, using unused subobjective 7, eSubObj_ObtainShards -- re-purposed to "Launch satellite over occupied country." Possessing the skeleton key and having a satellite over an occupied country triggers the detection (creation) of an alien base alert for that country.
new localization entry : SubObjectiveNames[eSubObj_ObtainShards] = "Launch a satellite over an occupied country."
Could rename the eSubObj_ObtainShards to   eSubObj_OrbitSatelit